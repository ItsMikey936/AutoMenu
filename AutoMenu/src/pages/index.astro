---
import Layout from '../layouts/Layout.astro'
import "../styles/global.css"
import pool from '../db.js';

// Carga los datos iniciales del menú semanal
const [dias] = await pool.query('SELECT * FROM dias ORDER BY id_Dia');
const [tiposComida] = await pool.query('SELECT * FROM tipos_Comida ORDER BY id_Tipos_Comida');
const [menus] = await pool.query(`
  SELECT 
    m.id_Dia, 
    m.id_Tipos_Comida, 
    d.dia AS nombre_dia, 
    t.nombre_Tipo AS nombre_tipo, 
    p.nombre_Platillo
  FROM menus m
  JOIN dias d ON m.id_Dia = d.id_Dia
  JOIN tipos_Comida t ON m.id_Tipos_Comida = t.id_Tipos_Comida
  JOIN Platillos p ON m.id_Platillo = p.id_Platillo
  ORDER BY m.id_Tipos_Comida, m.id_Dia
`);

const menuTable = {};
for (const tipo of tiposComida) {
  menuTable[tipo.nombre_Tipo] = {};
  for (const dia of dias) {
    const celda = menus.find(m => m.id_Dia === dia.id_Dia && m.id_Tipos_Comida === tipo.id_Tipos_Comida);
    menuTable[tipo.nombre_Tipo][dia.dia] = celda ? celda.nombre_Platillo : '';
  }
}
---

<Layout>
  <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Menú Semanal</h1>

  <div class="flex justify-center mb-6">
    <button 
      id="aleatorio-btn" 
      class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-500 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-600 transition duration-300"
    >
      Generar menú aleatorio
    </button>
  </div>

  <div class="overflow-x-auto shadow rounded-lg border border-gray-200">
    <table id="menu-table" class="min-w-full table-auto">
      <thead class="bg-gray-100 text-gray-700 text-sm uppercase tracking-wider">
        <tr>
          <th class="px-6 py-3 text-left">Tipo de Comida</th>
          {dias.map(dia => (
            <th class="px-6 py-3 text-left">{dia.dia}</th>
          ))}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 bg-white text-gray-800">
        {tiposComida.map(tipo => (
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 font-semibold">{tipo.nombre_Tipo}</td>
            {dias.map(dia => (
              <td class="px-6 py-4">{menuTable[tipo.nombre_Tipo][dia.dia]}</td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  </div>

  <script type="module">
    const btn = document.getElementById('aleatorio-btn');
    btn.addEventListener('click', async () => {
      const res = await fetch('/api/menu-aleatorio');
      const data = await res.json();
      const { menuTable, dias, tiposComida } = data;
      const tbody = document.querySelector('#menu-table tbody');
      tbody.innerHTML = '';
      tiposComida.forEach(tipo => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";
        const tdTipo = document.createElement('td');
        tdTipo.className = "px-6 py-4 font-semibold";
        tdTipo.innerHTML = tipo.nombre_Tipo;
        tr.appendChild(tdTipo);
        dias.forEach(dia => {
          const td = document.createElement('td');
          td.className = "px-6 py-4";
          td.textContent = menuTable[tipo.nombre_Tipo][dia.dia];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    });
  </script>
</Layout>
